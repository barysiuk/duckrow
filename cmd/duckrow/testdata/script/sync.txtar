# Test duckrow sync: install skill, delete it, sync restores it

# Create skill repo
mkdir skill-source
cp skill-md skill-source/SKILL.md
setup-git-repo skill-source test-skills test-skill

# Set up config override
setup-config-override test-owner/test-repo skill-source

# Create project and install a skill (creates lock file)
mkdir myproject
exec duckrow skill install https://github.com/test-owner/test-repo -d myproject
stdout 'Installed: test-skill'
exists myproject/.agents/skills/test-skill/SKILL.md
exists myproject/duckrow.lock.json

# Verify lock file has the skill
file-contains myproject/duckrow.lock.json '"name": "test-skill"'
file-contains myproject/duckrow.lock.json '"commit":'

# Sync with skill already present should skip it
exec duckrow sync -d myproject
stdout 'Skills: 0 installed, 1 skipped, 0 errors'

# Delete the skill directory
exec rm -rf myproject/.agents/skills/test-skill

# Verify skill is gone
dir-not-exists myproject/.agents/skills/test-skill

# Sync should restore the skill from the lock file
exec duckrow sync -d myproject
stdout 'Installed: test-skill'
stdout 'Skills: 1 installed, 0 skipped, 0 errors'

# Verify skill is restored
exists myproject/.agents/skills/test-skill/SKILL.md
file-contains myproject/.agents/skills/test-skill/SKILL.md 'test-skill'

# Sync without a lock file should error
mkdir nolockproject
! exec duckrow sync -d nolockproject
stderr 'no duckrow.lock.json found'

-- skill-md --
---
name: test-skill
description: A skill for testing
metadata:
  author: tester
---
# Test Skill

This is a test skill.
