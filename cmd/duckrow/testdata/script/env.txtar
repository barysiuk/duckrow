# Test env command - runtime helper for MCP environment injection

# Create a project directory with lock file
mkdir myproject

# Create a lock file with an MCP entry that requires env vars
cp lock-with-mcp myproject/duckrow.lock.json

# Create .env.duckrow with the required values
write-env-file myproject DB_HOST=localhost DB_USER=admin

# Test: env command with echo shows the env was set up
# (syscall.Exec replaces the process, so we use sh -c to capture output)
exec duckrow env --mcp my-db -d myproject -- sh -c 'echo DB_HOST=$DB_HOST DB_USER=$DB_USER'
stdout 'DB_HOST=localhost'
stdout 'DB_USER=admin'

# Test: Missing --mcp flag shows error
! exec duckrow env -- echo hello
stderr '--mcp flag is required'

# Test: Missing command after -- shows error
! exec duckrow env --mcp my-db
stderr 'no command specified'

# Test: MCP not in lock file shows error
! exec duckrow env --mcp nonexistent -d myproject -- echo hello
stderr 'not found in lock file'

# Test: No lock file shows error
mkdir empty-project
! exec duckrow env --mcp my-db -d empty-project -- echo hello
stderr 'duckrow.lock.json not found'

# Test: Missing env var shows warning but still runs
cp lock-with-missing-env myproject/duckrow.lock.json
exec duckrow env --mcp needs-secret -d myproject -- sh -c 'echo ran'
stderr 'Warning: env var SECRET_KEY required'
stdout 'ran'

# Test: Process environment takes precedence over .env.duckrow
env DB_HOST=from-environ
exec duckrow env --mcp my-db -d myproject -- sh -c 'echo DB_HOST=$DB_HOST'
# Process env has highest priority
stdout 'DB_HOST=from-environ'

-- lock-with-mcp --
{
  "skills": [],
  "mcps": [
    {
      "name": "my-db",
      "registry": "test-registry",
      "configHash": "abc123",
      "agents": ["cursor"],
      "requiredEnv": ["DB_HOST", "DB_USER"]
    }
  ]
}
-- lock-with-missing-env --
{
  "skills": [],
  "mcps": [
    {
      "name": "my-db",
      "registry": "test-registry",
      "configHash": "abc123",
      "agents": ["cursor"],
      "requiredEnv": ["DB_HOST", "DB_USER"]
    },
    {
      "name": "needs-secret",
      "registry": "test-registry",
      "configHash": "def456",
      "agents": ["cursor"],
      "requiredEnv": ["SECRET_KEY"]
    }
  ]
}
