# Test installing a skill from a configured registry by name

# Create a project directory
mkdir myproject

# Create a skill repo with actual SKILL.md files and a registry manifest.
# The Source field in the manifest points to "fake-owner/skill-source"
# (a GitHub shorthand) which we redirect via clone URL override.
mkdir skill-repo/skills/go-review
cp go-review-skill skill-repo/skills/go-review/SKILL.md
mkdir skill-repo/skills/py-review
cp py-review-skill skill-repo/skills/py-review/SKILL.md
cp manifest skill-repo/duckrow.json

# Turn it into a git repo
exec git -C skill-repo init
exec git -C skill-repo checkout -b main
exec git -C skill-repo add .
exec git -C skill-repo -c user.email=test@test.com -c user.name=Test commit -m initial

# Add the registry (this clones the repo and writes to config)
exec duckrow registry add skill-repo
stdout 'Added registry: my-org'

# Add a clone URL override to the existing config so that
# "fake-owner/skill-source" (the Source in the manifest) resolves locally
setup-registry-config fake-owner/skill-source skill-repo

# Install using registry name lookup â€” resolves from registry
exec duckrow skill install go-review -d myproject
stdout 'Installed: go-review'
! stdout 'py-review'

# Verify the skill was installed
exists myproject/.agents/skills/go-review/SKILL.md
file-contains myproject/.agents/skills/go-review/SKILL.md 'Go code reviewer'
dir-not-exists myproject/.agents/skills/py-review

# Verify lock file has source populated (not empty)
exists myproject/duckrow.lock.json
file-contains myproject/duckrow.lock.json '"source":'
file-contains myproject/duckrow.lock.json '"commit":'

# Test: registry name lookup with nonexistent skill shows error
! exec duckrow skill install nonexistent -d myproject
stderr 'not found'

# Test: no args shows error (requires exactly 1 arg)
! exec duckrow skill install
stderr 'accepts 1 arg'

# Test: --registry without a URL arg is a registry lookup
exec duckrow skill install go-review --registry my-org -d myproject
stdout 'Installed: go-review'

# Test: --registry with a URL source shows error
! exec duckrow skill install https://github.com/some-owner/some-repo --registry my-org
stderr '--registry cannot be used with a direct URL source'

-- manifest --
{
  "name": "my-org",
  "description": "Test organization skills",
  "skills": [
    {
      "name": "go-review",
      "description": "Go code reviewer",
      "source": "fake-owner/skill-source",
      "version": "1.0.0"
    },
    {
      "name": "py-review",
      "description": "Python code reviewer",
      "source": "fake-owner/skill-source",
      "version": "1.0.0"
    }
  ]
}
-- go-review-skill --
---
name: go-review
description: Go code reviewer
metadata:
  version: "1.0.0"
---
# Go Review

Review Go code for best practices.
-- py-review-skill --
---
name: py-review
description: Python code reviewer
metadata:
  version: "1.0.0"
---
# Python Review

Review Python code for best practices.
