# Test installing a skill from a configured registry using --skill flag

# Create a project directory
mkdir myproject

# Create a skill repo with actual SKILL.md files and a registry manifest.
# The Source field in the manifest points to "fake-owner/skill-source"
# (a GitHub shorthand) which we redirect via clone URL override.
mkdir skill-repo/skills/go-review
cp go-review-skill skill-repo/skills/go-review/SKILL.md
mkdir skill-repo/skills/py-review
cp py-review-skill skill-repo/skills/py-review/SKILL.md
cp manifest skill-repo/duckrow.json

# Turn it into a git repo
exec git -C skill-repo init
exec git -C skill-repo checkout -b main
exec git -C skill-repo add .
exec git -C skill-repo -c user.email=test@test.com -c user.name=Test commit -m initial

# Add the registry (this clones the repo and writes to config)
exec duckrow registry add skill-repo
stdout 'Added registry: my-org'

# Add a clone URL override to the existing config so that
# "fake-owner/skill-source" (the Source in the manifest) resolves locally
setup-registry-config fake-owner/skill-source skill-repo

# Install using --skill (no source argument) â€” resolves from registry
exec duckrow install --skill go-review -d myproject
stdout 'Installed: go-review'
! stdout 'py-review'

# Verify the skill was installed
exists myproject/.agents/skills/go-review/SKILL.md
file-contains myproject/.agents/skills/go-review/SKILL.md 'Go code reviewer'
dir-not-exists myproject/.agents/skills/py-review

# Test: --skill with nonexistent skill shows available skills
! exec duckrow install --skill nonexistent -d myproject
stderr 'not found'
stderr 'Available'

# Test: no args and no --skill shows error
! exec duckrow install
stderr 'source'
stderr '--skill'

# Test: --registry without --skill shows error
! exec duckrow install --registry my-org
stderr '--registry requires --skill'

# Test: --registry with a source argument shows error
! exec duckrow install some-owner/some-repo --registry my-org --skill foo
stderr '--registry can only be used with --skill'

-- manifest --
{
  "name": "my-org",
  "description": "Test organization skills",
  "skills": [
    {
      "name": "go-review",
      "description": "Go code reviewer",
      "source": "fake-owner/skill-source",
      "version": "1.0.0"
    },
    {
      "name": "py-review",
      "description": "Python code reviewer",
      "source": "fake-owner/skill-source",
      "version": "1.0.0"
    }
  ]
}
-- go-review-skill --
---
name: go-review
description: Go code reviewer
metadata:
  version: "1.0.0"
---
# Go Review

Review Go code for best practices.
-- py-review-skill --
---
name: py-review
description: Python code reviewer
metadata:
  version: "1.0.0"
---
# Python Review

Review Python code for best practices.
